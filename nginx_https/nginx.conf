worker_processes auto;
events { worker_connections 16384; }

error_log stderr debug;

http {

    server_tokens             off;
    sendfile                  on;

    ssl_session_cache         shared:SSL:10m;
    ssl_session_timeout       10m;
    ssl_protocols             TLSv1.2 TLSv1.3;
    ssl_ciphers               'ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-RSA-AES128-GCM-SHA256';
    ssl_ecdh_curve            secp256r1:secp384r1:secp521r1;
    ssl_prefer_server_ciphers on; 
    ssl_verify_client         off;

    proxy_ssl_server_name     on;
    proxy_ssl_protocols       TLSv1.2 TLSv1.3;
    proxy_ssl_ciphers         HIGH:!aNULL:!MD5;
    proxy_ssl_session_reuse   on;
    proxy_read_timeout        3600;
    proxy_send_timeout        3600;

    proxy_http_version        1.1;
    proxy_request_buffering   off;
    proxy_buffering           off;
    proxy_cache               off;            # Don't cache
    proxy_set_header          Connection "";  # Ensure keep-alive connection
    chunked_transfer_encoding off;            # Optional: do not re-chunk response
    client_max_body_size      10M;

    ssl_certificate           /certs/cert.pem;
    ssl_certificate_key       /certs/key.pem;
    ssl_password_file         /certs/password.txt;

    add_header                Strict-Transport-Security "max-age=31536000; includeSubDomains" always;

    # Log format & access log

    log_format main       '$remote_addr "$remote_user" "$http_x_forwarded_for" [$time_iso8601] "$request" $status $limit_req_status $request_time $body_bytes_sent "$http_referer" "$http_user_agent"';

    access_log /var/log/nginx_access.log main;

    resolver 10.43.0.10 valid=5s ipv6=off;
    resolver_timeout 5s;


    # --- Maps used by multiple services ---

    # Upgrade headers for web socket connections like HCL Nomad
    map $http_upgrade $connection_upgrade {
      default upgrade;
      '' close;
    }

    # Get host part from FQDN
    map $host $first_label {
        ~^([^.]+)  $1;
        default    "";
    }

    # Map target from first part of FQDN to service
    map $first_label $upstream_target {
        rancher        rancher.cattle-system.svc.cluster.local;
        cube-control   cube-control.domino.svc.cluster.local;
        default   "";
    }

    # Split client example
    split_clients "${remote_addr}${http_user_agent}" $verse_backend {
       50% "dom-mail01a";
       *   "dom-mail01b";
    }

    # --- SUSE Rancher ---
   
    server {
        listen        127.0.0.1:8443 ssl;
        server_name   _;
        http2         on;

        location / {

            proxy_pass         https://$upstream_target;
            proxy_ssl_name     $host;
            proxy_set_header   Host $host;
            proxy_set_header   X-Real-IP $remote_addr;
            proxy_set_header   X-Forwarded-Proto $scheme;
            proxy_set_header   X-Forwarded-Port $server_port;
            proxy_set_header   X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header   Upgrade $http_upgrade;
            proxy_set_header   Connection $connection_upgrade;
            proxy_read_timeout 900s;
            proxy_buffering    off;
        }
    }

    # Redirect HTTP to HTTPS on NGINX level
    server {
        listen 80 default_server;
        listen [::]:80 default_server;
        server_name _;

        location / {
            return 301 https://$host$request_uri;
        }
    }

}


stream {

  resolver 10.43.0.10 valid=60s;

  # Get host part from FQDN SNI
  map $ssl_preread_server_name $first_label {
        ~^([^.]+)  $1;
        default    "";
  }

  # HTTPS Domino service mapping with special backend for rancher on localhost 8443
  map $first_label $domino_service {
        ~^dom-[a-z0-9-]+$  $first_label.domino.svc.cluster.local:443;
        rancher            127.0.0.1:8443;
        cube-control       127.0.0.1:8443;
        default            "";
  }

  # Nomad request mapping
  map $first_label $nomad_service {
        ~^dom-[a-z0-9-]+$  $first_label.domino.svc.cluster.local:9443;
        default            "";
  }

  # HTTPS targets
  server {
    listen       443;
    proxy_pass   $domino_service;
    ssl_preread  on;
  }

  # Nomad on port 9443
  server {
    listen       9443;
    proxy_pass   $nomad_service;
    ssl_preread  on;
  }

}

